<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<exportmultiplex category="Template" ref_path="workflow_data[Internal]/storable[workflow_data]/storable[Data]">
   <list classname="java.util.ArrayList" name="Comments"/>
   <storable name="Execution Config" storable-id="dr.WorkflowExecutionConfig" ver="10.0">
      <enum name="debugType" storable-id="dr.DebugType" value="EVENT"/>
      <storable name="executionSettings" storable-id="dr.ExecutionSettings" ver="11.0">
         <boolean name="enabled" value="false"/>
         <storable name="kafka" null="true"/>
      </storable>
      <int name="noOfFilesToKeep" value="0"/>
      <string name="throughputMIM" null="true"/>
      <string name="txnHandler" value="Default Handler"/>
   </storable>
   <list classname="java.util.ArrayList" name="Field Types"/>
   <list classname="java.util.ArrayList" name="Logged error MIM"/>
   <list classname="java.util.ArrayList" name="Nodes">
      <storable name="0" storable-id="dr.WfNode" ver="2.0">
         <string name="Classname"><![CDATA[com.digitalroute.mz.rest_server.agent.RestServerCollectorAgentInspRT]]></string>
         <array classname="com.digitalroute.wf.WfNodeConfig" name="Configuration" size="1">
            <storable name="0" storable-id="dr.WfNodeConfig" ver="1.0">
               <string name="Classname"><![CDATA[com.digitalroute.mz.rest_server.agent.RestServerCollectorAgentInspRT]]></string>
               <storable name="Data" storable-id="dr.RestServerData" ver="30.0">
                  <string name="advancedProperties"><![CDATA[# Properties controlling REST Server collector can be customized here.
# Please read the user documentation before changing these properties.

# If true, REST server will send authentication error directly to client without
# routing REST Cycle UDR to output.
auto.auth.error.response.enabled=true

# If true, REST server will send endpoint URI not found error directly to client without
# routing REST Cycle UDR to output.
auto.endpoint.uri.not.found.response.enabled=true
]]></string>
                  <boolean name="autoAuthErrorResponseEnabled" value="true"/>
                  <boolean name="autoEndpointURINotFoundResponseEnabled" value="true"/>
                  <boolean name="certificateValidation" value="false"/>
                  <boolean name="certificateValidationActive" value="false"/>
                  <string name="crl" value=""/>
                  <boolean name="crldp" value="false"/>
                  <list classname="java.util.ArrayList" name="endpointURIs">
                     <string name="0" value="/todos/"/>
                  </list>
                  <string name="host" value="192.168.2.100"/>
                  <boolean name="isTwoWayAuth" value="false"/>
                  <string name="jwtPublicKeyAlias" null="true"/>
                  <boolean name="jwtPublicKeyAliasActive" value="false"/>
                  <int name="maxProcessingTime" value="5"/>
                  <int name="maxQueuedThreadPool" value="64"/>
                  <int name="minQueuedThreadPool" value="8"/>
                  <string name="oauthTruststore" null="true"/>
                  <boolean name="oauthTruststoreActive" value="false"/>
                  <password name="oauthTsPassphrase" value="DR-4-017BB0B8FB061C1876D43DD75468AA40"/>
                  <boolean name="oauthTsPassphraseActive" value="false"/>
                  <int name="port" value="8091"/>
                  <storable name="restServerProfile" storable-id="dr.DRConfiguration" ver="2.0">
                     <set name="Dynamic Parameters" null="true"/>
                     <string name="Folder" value="SAPCM-SEPT25_RT_OPEN-API"/>
                     <string name="Key" value="DR1763876286409"/>
                     <string name="Name" value="PRF_REST_SERVER_TODO"/>
                     <string name="Type" value="REST Server Profile"/>
                  </storable>
                  <storable name="securityProfile" null="true"/>
                  <string name="tlsKeystore" null="true"/>
                  <boolean name="tlsKeystoreActive" value="false"/>
                  <password name="tlsKsPassphrase" value="DR-4-017BB0B8FB061C1876D43DD75468AA40"/>
                  <string name="twoWayTruststore" null="true"/>
                  <boolean name="twoWayTruststoreActive" value="false"/>
                  <password name="twoWayTsPassphrase" value="DR-4-017BB0B8FB061C1876D43DD75468AA40"/>
                  <boolean name="twoWayTsPassphraseActive" value="false"/>
                  <storable name="udrType" null="true"/>
                  <boolean name="useOAuth_2_0" value="false"/>
                  <boolean name="useSecurityProfile" value="false"/>
                  <boolean name="useTLS" value="false"/>
               </storable>
            </storable>
         </array>
         <string name="Name" value="REST_Server_Deprecated_1"/>
      </storable>
      <storable name="1" storable-id="dr.WfNode" ver="2.0">
         <string name="Classname" value="com.digitalroute.wfc.analysis.AnalysisRealtimeInsp"/>
         <array classname="com.digitalroute.wf.WfNodeConfig" name="Configuration" size="1">
            <storable name="0" storable-id="dr.WfNodeConfig" ver="1.0">
               <string name="Classname" value="com.digitalroute.wfc.analysis.AnalysisRealtimeInsp"/>
               <storable name="Data" storable-id="dr.StuffyMapperData" ver="10.0">
                  <string name="sourceCode"><![CDATA[import ultra.openapi.SAPCM-SEPT25_RT_OPEN-API.PRF_OPEN_API_TODO;
list<ToDoItem> items = listCreateSync(ToDoItem);
long todoSeqId = 1;
synchronized void incId(){
    todoSeqId = todoSeqId + 1;        
}
consume {
    
    if(instanceOf(input,Cycle)){
        Cycle cycle = (Cycle)input;
        debug("Req:"+cycle);
        if(cycle.request.requestedUri == "/todos"){
            if(cycle.request.httpMethod == "GET"){
                 bytearray ba;
                 strToBA(ba,jsonEncodeList(items));
                 cycle.response = createResponse(ba,200);
                 setHeader(cycle.response);
                 debug("Response:"+cycle);  
                 udrRoute(cycle); 
            }   
            else if(cycle.request.httpMethod == "POST"){
                 string jsonStr = baToStr(cycle.request.body);
                 ToDoItemInput ipItem = udrCreate(ToDoItemInput);
                 jsonDecodeUdr(jsonStr,ipItem);
                 
                 ToDoItem item = udrCreate(ToDoItem);
                 item.id = todoSeqId;
                 item.completed = ipItem.completed;
                 item.description = ipItem.description;
                 item.title = ipItem.title;
                 
                 listAdd(items,item);
                 incId();
                 bytearray ba;
                 strToBA(ba,jsonEncodeUdr(item));
                 cycle.response = createResponse(ba,200);
                 setHeader(cycle.response);
                 debug("Response:"+cycle);  
                 udrRoute(cycle); 
            }else if(cycle.request.httpMethod == "OPTIONS"){
                 debug("CORS req");
                 cycle.response = udrCreate(Response);
                 cycle.response.httpResponseCode = 200;
                 setHeader(cycle.response);
                 debug("Response:"+cycle);  
                 udrRoute(cycle);
            }    
        }
    }
}
Response createResponse(bytearray body, int code){
    Response resp = udrCreate(Response);
    resp.body = body;
    resp.httpResponseCode = code;
    return resp;    
}
void setHeader(Response resp){
    resp.headerFields = mapCreate(string,list<string>);
    map<string,list<string>> headers = resp.headerFields;
    
    mapSet(headers,"Access-Control-Allow-Origin", listCreate(string,"*"));
    mapSet(headers,"Access-Control-Allow-Methods", listCreate(string,"GET, POST, PUT, DELETE, OPTIONS"));
    mapSet(headers,"Access-Control-Allow-Headers", listCreate(string,"Content-Type"));
    mapSet(headers,"Access-Control-Max-Age",      listCreate(string,"3600"));
    mapSet(headers,"Content-Type", listCreate(string, "application/json"));

}]]></string>
                  <array classname="com.digitalroute.devkit.drudr.DRTypeInfo" name="udrTypes" size="1">
                     <storable name="0" storable-id="dr.DRTypeInfo" ver="1.0">
                        <string name="TypeName" value="REST.Cycle"/>
                     </storable>
                  </array>
               </storable>
            </storable>
         </array>
         <string name="Name" value="Analysis_1"/>
      </storable>
   </list>
   <storable name="Persistent" storable-id="dr.WorkflowPersistentConfig" ver="10.0">
      <string name="persistentInspector" null="true"/>
      <storable name="persistentStorageConfig" null="true"/>
      <string name="persistentTimeoutHandler" null="true"/>
   </storable>
   <list classname="java.util.ArrayList" name="Routes">
      <storable name="0" storable-id="dr.WfRoute" ver="2.0">
         <string name="Name" value="r_1"/>
         <int name="Realtime mode" value="0"/>
      </storable>
      <storable name="1" storable-id="dr.WfRoute" ver="2.0">
         <string name="Name" value="r_2"/>
         <int name="Realtime mode" value="0"/>
      </storable>
   </list>
   <list classname="java.util.ArrayList" name="Service"/>
   <boolean name="Template Valid" value="true"/>
   <storable name="Thread data" storable-id="dr.WorkflowExecutionRealtimeConfig" ver="10.0">
      <int name="countInterval" value="1"/>
      <int name="queueSize" value="1000"/>
      <string name="queueStrategy" null="true"/>
      <string name="queueWorkerStrategy" null="true"/>
      <boolean name="standalone" value="false"/>
      <int name="threads" value="8"/>
   </storable>
</exportmultiplex>
